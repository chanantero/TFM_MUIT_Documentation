In this chapter, the mathematical basis of Wave Field Synthesis (WFS) is explained. First, the monochromatic wave equation in three dimensions and Green's Theorem are combined to prove that the wave field in a source-free space volume is totally determined by the wave field on its surface. Specifically, Kirchhoff integral and Rayleigh integral are the expressions that allow us to calculate the wave field at any point inside the volume using just its surface information, but Rayleigh integral is simpler and, hence, more convenient. %We will base the rest of the WFS theory on it.

The main idea of WFS is to use loudspeakers to generate a surface acoustic wave field identical to the one that would be created by a virtual sound source. Since the wave field inside the volume depends only on the surface one, it will be the same as the acoustic field that would be generated by the virtual source. The accuracy of WFS depends on how well we are able to replicate the surface wave field. We will see that we would need an infinite amount of monopole and dipole infinitesimal sources to generate an exact acoustic field, but it is obvious that in any real situation we can only use a finite number of loudspeakers that are not infinitesimal, nor they present ideal monopole or dipole radiation patterns. We will model a WFS system with discrete punctual sources and take a look at the problems and inaccuracies that derive from it.

\section{From Kirchhoff-Helmholtz Integral to WFS theory}
From three-dimensional wave equation and Green's Theorem, the Kirchhoff-Helmholtz Integral is deduced \cite{BerkhoutSeismic} \cite{Verheijen}:
\begin{equation}
P(\vec{x_0}) = \frac{1}{4\pi} \int_{S} \left(P(\vec{x})\frac{\partial G(\vec{x})}{\partial \mathbf{n}} - G(\vec{x}) \frac{\partial P(\vec{x})}{\partial \mathbf{n}} \right) dS
\label{KirchhoffHelmholtz}
\end{equation}

It expresses the pressure field $P(\vec{x_0})$ (particularized for a given frequency) inside a free-source volume $V$ bounded by the surface $S$ as a function of the pressure at $S$, and its directional derivative in the direction of $\vec{n}$, which is the inward pointing normal vector of $S$. $G$ is called Green's function, and should obey the inhomogeneous wave equation for a source at position $\vec{x}_0$ ($\Delta G - k^2 G = -4\pi\delta(\vec{x} - \vec{x}_0)$).

The general form of $G(\vec{x})$ is:
\begin{equation}
G(\vec{x}) = \frac{e^{-jk\norm{\vec{x} - \vec{x}_0}}}{\norm{\vec{x} - \vec{x}_0}} + F(\vec{x})
\label{GreensFunction}
\end{equation}
where $F(\vec{x})$ is any function that satisfies the Helmholtz equation $\Delta F - k^2 F = 0$.

If $F = 0$:
\begin{equation}
P(\vec{x_0}) = \frac{1}{4\pi} \int_{S} \left(P(\vec{x}) G(\vec{x})\left(jk + \frac{1}{\norm{\vec{x}_0 - \vec{x}}}\right)\cos\alpha - G(\vec{x}) \frac{\partial P(\vec{x})}{\partial \mathbf{n}} \right) dS
\end{equation}
where $\alpha = \left\langle \frac{\vec{x}_0 - \vec{x}}{\norm{\vec{x}_0 - \vec{x}}} , \vec{n} \right\rangle$ is the angle between the inward normal vector and the vector that goes from the point at the surface $\vec{x}$ and $\vec{x}_0$.

It can be interpreted as if the field inside $V$ was the result of the field generated by infinitesimal sources distributed over $S$. The first term of the integral represents a dipole source distribution driven by the pressure at the surface. The dipoles have the inward normal vector as broadside direction. The second term of the integral represents a monopole source distribution driven by the directional derivative of the pressure at the surface. The result of the integral outside $V$ is $0$. The original sources that generate the field are called primary sources. The surface monopole and dipole source distributions that can emulate the field inside the volume will be called secondary sources.

Kirchhoff-Helmholtz integral can be simplified at the cost of a fixed surface geometry and a non-zero field outside the volume, but those limitations are of little importance in practice for WFS. The simplified integrals, known as Rayleigh I and II integrals, are found by choosing a particular surface of integration and a suitable function $F$.

The new volume is a hemisphere. The surface is then constituted by a flat circle $S_1$ with radius $R$ and the spherical surface $S_2$. For mathematical convenience and without loss of generalization, $S_1$ will be located at the plane $z=0$ ($\vec{n} = \hat{z}$), $S_2$ at $z>0$, and all primary sources will be located at $z<0$. When $R\rightarrow\infty$, the Sommerfeld condition is satisfied and the integral over $S_2$ becomes $0$ \cite{Verheijen}.

If $F = \frac{e^{-jk\norm{\vec{x} - \vec{x}'_0}}}{\norm{\vec{x} - \vec{x}'_0}}$, being $\vec{x}'_0$ the mirrored image of $\vec{x}_0$ in the plane $S_1$, then the directional derivative of $G$ becomes $0$ at $S_1$, and \autoref{KirchhoffHelmholtz} transforms to:
\begin{equation}
P(\vec{x_0}) = \frac{-1}{2\pi} \int_{S_1} \frac{e^{-jk\norm{\vec{x} - \vec{x}_0}}}{\norm{\vec{x} - \vec{x}_0}} \frac{\partial P(\vec{x})}{\partial \mathbf{n}} dS
\label{RaileighI}
\end{equation}
Previous equation is called Raileigh I integral and states that a secondary planar monopole source distribution can synthesize on one side of the plane $S_1$ ($z>0$) the field of a primary source distribution located at the other side ($z<0$). The monopole sources are driven by two times the directional derivative of the pressure at the plane, in its perpendicular direction.

The function $F$ can also be chosen to remove the monopole source distributions: $F = -\frac{e^{-jk\norm{\vec{x} - \vec{x}'_0}}}{\norm{\vec{x} - \vec{x}'_0}}$. In this case, \autoref{KirchhoffHelmholtz} transforms to the Raileigh II integral:
\begin{equation}
P(\vec{x_0}) = \frac{1}{2\pi} \int_{S_1} P(\vec{x}) \frac{e^{-jk\norm{\vec{x} - \vec{x}_0}}}{\norm{\vec{x} - \vec{x}_0}}\left(jk + \frac{1}{\norm{\vec{x}_0 - \vec{x}}}\right)\cos\alpha dS
\end{equation}
It presents a similar scenario as Raileigh I integral, but instead of monopole secondary sources, it uses dipole sources driven by two times the pressure at plane $S_1$.

Given that planer loudspeaker arrays are less convenient than linear arrays in practical situations, a dimensionality reduction from 3D to 2D is desirable, as it is proposed in \cite{Vogel} and developed in \cite{stuart1996application} and \cite{Verheijen}.

Staying with Raileigh I scenario, let's assume that all primary sources and the positions where we want to synthesize their field are all located in the same plane, for example, $y = 0$. The pressure field generated by a primary source located at $\vec{x}_s$ is modelled in the next way: $P(\vec{x}) = \coef \Diag(\phi, \theta) \GreenFunc[\vec{x} - \vec{x}_s]$, where $\coef$ is the source coefficient and $\Diag(\phi, \theta)$ is the directivity pattern.

Raileigh I integral (\autoref{RaileighI}) can be transformed to a line integral in the $x$ direction by integrating along the $y$ direction:

\begin{gather}
P(\vec{x_0}) = \frac{-1}{2\pi} \int_{S_1} \frac{e^{-jk\norm{\vec{x} - \vec{x}_0}}}{\norm{\vec{x} - \vec{x}_0}} \frac{\partial P(\vec{x})}{\partial \mathbf{n}} dS = \frac{-1}{2\pi} \int_{-\infty}^{\infty} \int_{-\infty}^{\infty} \frac{e^{-jk\norm{\vec{x} - \vec{x}_0}}}{\norm{\vec{x} - \vec{x}_0}} \frac{\partial P(\vec{x})}{\partial \mathbf{n}} dy dx = \frac{-1}{2\pi} \int_{-\infty}^{\infty} I(x) dx \\
I(x) = \int_{-\infty}^{\infty} \frac{e^{-jk\norm{\vec{x} - \vec{x}_0}}}{\norm{\vec{x} - \vec{x}_0}} \frac{\partial P(\vec{x})}{\partial \mathbf{n}} dy
%I(x) = \int_{-\infty}^{\infty} \frac{e^{-jk\sqrt{(x - x_0)^2 + y^2 + (z-z_0)^2}}}{\sqrt{(x - x_0)^2 + y^2 + (z-z_0)^2}} \frac{\partial P(\vec{x})}{\partial \mathbf{n}} dy
\label{LineIntegral}
\end{gather}

So, the question is how to calculate $I(x)$. We start by calculating the directional derivative of the pressure, which is \cite{Verheijen}
\begin{multline}
\frac{\partial P(\vec{x})}{\partial \mathbf{n}} = \frac{\partial \coef \Diag(\phi, \theta) \GreenFunc[\vec{x} - \vec{x}_s]}{\partial \mathbf{z}} = \\ -A \GreenFunc[\vec{x} - \vec{x}_s] \left[ \frac{\sin\phi}{\norm{\vec{x} - \vec{x}_s}\cos\theta}\frac{\partial\Diag}{\partial\phi} + \frac{\cos\phi \sin\theta}{\norm{\vec{x} - \vec{x}_s}} \frac{\partial\Diag}{\partial\theta} + \left(jk + \frac{1}{\norm{\vec{x} - \vec{x}_s}}\right) \Diag \cos\phi \cos\theta \right]
\label{derivPressure}
\end{multline}

Inserting \autoref{derivPressure} in \autoref{LineIntegral} we get:
\begin{equation}
I(x) = -\int_{-\infty}^{\infty} \GreenFunc[\vec{x} - \vec{x}_0] A \GreenFunc[\vec{x} - \vec{x}_s] \left[ \frac{\sin\phi}{\norm{\vec{x} - \vec{x}_s}\cos\theta}\frac{\partial\Diag}{\partial\phi} + \frac{\cos\phi \sin\theta}{\norm{\vec{x} - \vec{x}_s}} \frac{\partial\Diag}{\partial\theta} + \left(jk + \frac{1}{\norm{\vec{x} - \vec{x}_s}}\right) \Diag \cos\phi \cos\theta \right] dy
\label{integrateY}
\end{equation}

According to the stationary phase method \cite{Verheijen},
\begin{equation}
I = \int_{-\infty}^{+\infty} f(y) e^{j\phi(y)} dy \approx f(y_0) e^{j\phi(y_0)} \sqrt{\frac{j 2\pi}{\phi''(y_0)}}
\end{equation}
where $y_0$ is the value of $y$ where the phase gets stationary $\frac{d\phi(y)}{dy} = 0$, and $\phi''(y_0)$ is the second derivative of $\phi$ evaluated at $y_0$. Intuitively, it means that the integral of a phase changing function only has a significant contribution in the region where the phase change slows down.

Applying it to \autoref{integrateY}, we get that
\begin{gather}
	y_0 = 0 \\
	\phi(y_0) = -k(r_{s0} + r_{00}) \\
	\phi''(y_0) = -k\frac{r_{s0} + r_{00}}{r_{s0} r_{00}} \\
	f(y_0) = -\frac{A}{r_{s0} r_{00}}\left[ \frac{\sin\phi}{r_{s0}} \frac{\partial\Diag}{\partial\phi} + \left(jk + \frac{1}{r_{s0}}\right) \Diag(\phi, 0) \cos\phi \right]
\end{gather}
where $r_{s0} = \norm{\vec{x} - \vec{x}_s}\Big\vert_{y = 0} = \sqrt{z_s^2 + (x - x_s)^2}$ and $r_{00} = \norm{\vec{x} - \vec{x}_0}\Big\vert_{y = 0} = \sqrt{z_0^2 + (x - x_0)^2}$.

Assuming $kr_{s0} >> 1$
\begin{gather}
P(\vec{x_0}) = \frac{-1}{2\pi} \int_{-\infty}^{\infty} I(x) dx = \int_{-\infty}^{\infty} Q(x) \frac{e^{-jkr_{00}}}{r_{00}} dx \label{RaileighI2.5}\\ 
Q(x) = A \Diag(\phi, 0) \cos\phi \frac{e^{-jk r_{s0}}}{\sqrt{r_{s0}}} \sqrt{\frac{jk}{2\pi}} \sqrt{\frac{r_{00}}{r_{s0} + r_{00}}} dx
\end{gather}

Applying the stationary phase method, but now in the x direction, we would find that the main contribution to the pressure at a given point comes from the intersection of the secondary source line and the line that goes from the primary source to the receiver point. Taking advantage of this, we can fixate $r_{00} = d$ and $r_{s0} = z_s$, so $Q(x)$ becomes independent from the receiver point (implementable in real WFS systems) and the pressure will be rightly scaled at a line of receivers parallel to the secondary source line, and separated a distance $d$. For other values of $d$, there will be amplitude errors \cite{Verheijen}.

In practice, a continuous secondary source line is not realistic. An discrete linear secondary source array is a closer model to the practical cases where an array of loudspeakers is used. The issue with discretization is that aliasing effects appear. However, as it is exposed in \cite{Start1997}, the synthesized wavefield will be exactly equal to the one with a continuous line source at those frequencies that respect next relation:
\begin{equation}
f < \frac{c}{2\Delta x}
\end{equation}

This means that, for a sound signal with $f_{max}$ as maximum frequency component, and with $\lambda_{min} = c/f_{max}$ as its corresponding wavelength, aliasing will be avoided as long as the separation between loudspeakers is smaller than half the wavelength: $\Delta x < \frac{\lambda_{min}}{2}$.

\section{Theoretical Propagation Model}
\label{TheoreticalModelLabel}

Each loudspeaker is considered as a punctual source with a given radiation pattern. The acoustic pressure waves propagate according to next equation:

\begin{equation}
P = c_\mathit{loud} D_{loud} G = c_\mathit{loud} D_{loud} \frac{e^{-j k \norm{\vec{r} - \vec{r}_\mathit{loud}}}}{\norm{\vec{r} - \vec{r}_\mathit{loud}}}
\end{equation}

\begin{description}
	\item[$P$] Acoustic pressure generated by the loudspeaker at point $\vec{r}$
	\item[$c_\mathit{loud}$] Complex coefficient of the signal transmitted %($x(t) = \Re\{c e^{j \omega t}\}$)
	\item[$D_{loud}$] Loudspeaker's radiation pattern contribution in the direction from $\vec{r}_\mathit{loud}$ to point $\vec{r}$% $\frac{\vec{r} - \vec{r}_\mathit{loud}}{\norm{\vec{r} - \vec{r}_\mathit{loud}}}$
	\item[$\vec{r}_{\mathit{loud}}$] Position of the loudspeaker
	\item[$G$] Green's function value for the distance between the loudspeaker and the point %$\norm{\vec{r} - \vec{r}_\mathit{loud}}$
\end{description}

In order to reproduce a signal through a loudspeaker, it must be created in the digital domain and then sent to the audio driver. The amplitude and phase relation between the digital signal created and the physical magnitude and phase of the transmitted one can be different for each loudspeaker. Hence, we need calibration coefficients for loudspeakers.

It is not possible to know the acoustic field at one point directly, we need to use a microphone that will transform the pressure to voltage, and then it will be digitized. The microphone will be modelled as a punctual receiver with a given radiation pattern and a calibration coefficient too.

%\begin{equation}
%	x_{l,m} = c_{l}^d \alpha_l D_{loud(l)}(\mathbf{r}_{loud(l)}, \mathbf{r}_{micro(m)}) G(\mathbf{r}_{loud(l)}, \mathbf{r}_{micro(m)}) D_{micro(m)}(\mathbf{r}_{loud(l)}, \mathbf{r}_{micro(m)}) \beta_m
%	\label{transEquationCalibration}
%\end{equation}
%
%\begin{description}
%	\item[$x_{(l,m)}$] Complex contribution of the $l$-th loudspeaker to the signal received by the $m$-th microphone
%	\item[$c_{l}^d$] Complex coefficient of the digital signal sent to the $l$-th loudspeaker
%	\item[$\alpha_m$] Calibration coefficient for the $m$-th source (loudspeaker)
%	\item[$D_{loud(l)}$] Radiation pattern of the $l$-th loudspeaker
%	\item[$\mathbf{r}_{loud(l)}$] Position of the $l$-th loudspeaker
%	\item[G] Green's function in 3D
%	\item[$\mathbf{r}_{micro(m)}$] Position of the $m$-th microphone
%	\item[$D_{micro(m)}$] Radiation pattern of the $m$-th microphone
%	\item[$\beta_n$] Calibration coefficient for the $m$-th microphone
%\end{description}

\begin{equation}
c_\mathit{micro} = c_\mathit{loud} \alpha D_{loud} G D_{micro} \beta = a \, c_\mathit{loud}
\label{transEquationCalibration}
\end{equation}

\begin{description}
	\item[$c_\mathit{micro}$] Complex coefficient of the signal received from the microphone
	\item[$c_\mathit{loud}$] Complex coefficient of the digital signal sent to the loudspeaker
	\item[$a$] Acoustic path
	\item[$\alpha$] Calibration coefficient for the loudspeaker
	\item[$\beta$] Calibration coefficient for the microphone
	\item[$D_{loud}$] Loudspeaker's radiation pattern contribution in the direction from $\vec{r}_{loud}$ to $\vec{r}_{micro}$
	\item[$D_{micro}$] Microphone's radiation pattern contribution in the direction from $\vec{r}_{micro}$ to $\vec{r}_{loud}$ 
	\item[$G$] Green's function value for the distance between loudspeaker and microphone
	\item[$\vec{r}_{loud}$] Position of loudspeaker
	\item[$\vec{r}_{micro}$] Position of microphone
\end{description}

If there are multiple microphones and loudspeakers, the relation between the transmitted and received signals for each combination of loudspeaker and microphone is characterized by an acoustic path. Let $L$ and $M$ be the number of loudspeakers and microphones respectively, then there are $L \dot M$ combinations.

\begin{gather}
c_{\mathit{micro} (m)} = \sum_{l = 1}^{L} a_{m,l} c_{\mathit{loud} (l)} \label{transEquationCalibrationConcrete} \\
a_{m,l} = \alpha_l D_{loud(l,m)} G_{l,m} D_{micro(l,m)} \beta_m
\label{acPathTheoric}
\end{gather}

\begin{description}
	\item[$D_{loud(l,m)}$] Loudspeaker's radiation pattern contribution in the direction from the $l$-th loudspeaker and the $m$-th microphone
	\item[$G_{l,m}$] Green's function value for the distance between the $l$-th loudspeaker and the $m$-th microphone
	\item[$D_{micro(l,m)}$] Microphone's radiation pattern contribution in the direction from the $m$-th microphone and the $l$-th loudspeaker
\end{description}

Previous equation can be expressed as a matrix operation:

\begin{equation}
\vec{c_\mathit{micro}} = \myMatrix{A} \vec{c_\mathit{louds}}
\label{transEqMatrix}
\end{equation}

\begin{description}
	\item[$\vec{c_\mathit{louds}}$] Column vector of signals transmitted by loudspeakers
 	\item[$\vec{c_\mathit{micro}}$] Column vector of signals received by microphones
	\item[$\myMatrix{A}$] Acoustic path matrix. The element in the $m$-th row and $l$-th column is $a_{m,l}$
\end{description}



