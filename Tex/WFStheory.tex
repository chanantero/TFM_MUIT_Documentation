In this chapter, the mathematical basis of Wave Field Synthesis (WFS) is explained. First, the monochromatic wave equation in three dimensions and Green's Theorem are combined to prove that the wave field in a source-free space volume is totally determined by the wave field on its surface. Specifically, Kirchhoff integral and Rayleigh integral are the expressions that allow us to calculate the wave field at any point inside the volume using just its surface information, but Rayleigh integral is simpler and, hence, more convenient. %We will base the rest of the WFS theory on it.

The main idea of WFS is to use loudspeakers to generate a surface acoustic wave field identical to the one that would be created by a virtual sound source. Since the wave field inside the volume depends only on the surface one, it will be the same as the acoustic field that would be generated by the virtual source. The accuracy of WFS depends on how well we are able to replicate the surface wave field. We will see that we would need an infinite amount of monopole and dipole infinitesimal sources to generate an exact acoustic field, but it is obvious that in any real situation we can only use a finite number of loudspeakers that are not infinitesimal, nor they present ideal monopole or dipole radiation patterns. We will model a WFS system with discrete punctual sources and take a look at the problems and inaccuracies that derive from it.

\section{Kirchhoff-Helmholtz Integral}
From three-dimensional wave equation and Green's Theorem, the Kirchhoff-Helmholtz Integral is deduced \cite{BerkhoutSeismic} \cite{Verheijen}:
\begin{equation}
P(\PosTheo) = \frac{1}{4\pi} \int_{S} \left(P(\PosTheo[surface])\frac{\partial G(\PosTheo[surface]\vert \PosTheo)}{\partial \mathbf{n}} - G(\PosTheo[surface]\vert \PosTheo) \frac{\partial P(\PosTheo[surface])}{\partial \mathbf{n}} \right) dS
\label{KirchhoffHelmholtz}
\end{equation}

It expresses the pressure field $\Field(\PosTheo)$ (particularized for a given frequency) inside a free-source volume $V$ bounded by the surface $\surfaceTheo$, as a function of the pressure at $\surfaceTheo$, and its directional derivative in the direction of $\surfaceNormal$, which is the inward pointing normal vector of $\surfaceTheo$ (\autoref{KirchhoffIntegralScheme}). $G(\PosTheo \vert \PosTheo_0)$ is called Green's function, and should obey the inhomogeneous wave equation for a source at position $\PosTheo_0$ ($\Delta G - k^2 G = -4\pi\delta(\PosTheo - \PosTheo_0)$).

\begin{figure}[h]
	\centering
	\def\svgwidth{1\columnwidth}
	\graphicspath{{../TFM/Img/}}
	\input{../TFM/Img/KirchhoffTheoScheme.pdf_tex}
	\caption{Scheme of Kirchhoff integral scenario}
	\label{KirchhoffIntegralScheme}
\end{figure}

The general form of $G(\PosTheo \vert \PosTheo_0)$ is:
\begin{equation}
G(\PosTheo \vert \PosTheo_0) = \GreenFunc[\PosTheo - \PosTheo_0] + F(\PosTheo \vert \PosTheo_0)
\label{GreensFunction}
\end{equation}
where $F(\PosTheo \vert \PosTheo_0)$ is any function that satisfies the Helmholtz equation $\Delta F - k^2 F = 0$.

If $F = 0$:
\begin{equation}
P(\PosTheo) = \frac{1}{4\pi} \int_{S} \left(P(\PosTheo[surface]) G(\PosTheo[surface] \vert \PosTheo)\left(jk + \frac{1}{\norm{\PosTheo - \PosTheo[surface]}}\right)\cos\normSecondPropAngle - G(\PosTheo[surface] \vert \PosTheo) \frac{\partial P(\PosTheo[surface])}{\partial \mathbf{n}} \right) dS
\end{equation}
where $\normSecondPropAngle = \left\langle \frac{\PosTheo - \PosTheo[surface]}{\norm{\PosTheo - \PosTheo[surface]}} , \vec{n} \right\rangle$ is the angle between the inward normal vector and the vector that passes through the point at the surface $\PosTheo[surface]$ and $\PosTheo$.

It can be interpreted as if the field inside $V$ was the result of the field generated by infinitesimal sources distributed over $S$. The first term of the integral represents a dipole source distribution driven by the pressure at the surface. The dipoles have the inward normal vector as broadside direction. The second term of the integral represents a monopole source distribution driven by the directional derivative of the pressure at the surface. The result of the integral outside $V$ is $0$. The original sources that generate the field are called primary sources. The surface monopole and dipole source distributions that can emulate the field inside the volume will be called secondary sources.

\section{Rayleigh I and II Integrals}
Kirchhoff-Helmholtz integral can be simplified at the cost of a fixed surface geometry and a non-zero field outside the volume, but those limitations are of little importance in practice for WFS. The simplified integrals, known as Rayleigh I and II integrals, are found by choosing a particular surface of integration and a suitable function $F$.

The new volume is a hemisphere. The surface is then constituted by a flat circle $\surfaceTheoRayleighPlane$ with radius $R$ and the spherical surface $\surfaceTheoRayleighSemisphere$. All primary sources will be located behind the flat circle (\autoref{RayleighIntegralScheme}).
\begin{figure}[h]
	\centering
	\def\svgwidth{0.6\columnwidth}
	\graphicspath{{../TFM/Img/}}
	\input{../TFM/Img/RayleighTheoScheme.pdf_tex}
	\caption{Scheme of Rayleigh integral scenario}
	\label{RayleighIntegralScheme}
\end{figure}
%For didactic purposes and without loss of generalization, $\surfaceTheoRayleighPlane$ will be located at the plane $z=0$ ($\vec{n} = \hat{z}$), $\surfaceTheoRayleighSemisphere$ at $z>0$, and all primary sources will be located at $z<0$.
When $R\rightarrow\infty$, the Sommerfeld condition is satisfied and the integral over $\surfaceTheoRayleighSemisphere$ becomes $0$ \cite{Verheijen}. This means $\PosTheo[surface] = [\PosTheo[surface][x], \PosTheo[surface][y], 0]$.

If $F(\PosTheo[surface] \vert \PosTheo) = \GreenFunc[ {\PosTheo[surface] - \PosTheo[mirrored]} ]$, being $\PosTheo[mirrored]$ the mirrored image of $\PosTheo$ in the plane $\surfaceTheoRayleighPlane$, then the directional derivative of $G$ becomes $0$ at $\surfaceTheoRayleighPlane$, and \autoref{KirchhoffHelmholtz} transforms to:
\begin{equation}
P(\PosTheo) = \frac{-1}{2\pi} \int_{\surfaceTheoRayleighPlane} \GreenFunc[{\PosTheo[surface] - \PosTheo}] \frac{\partial P(\PosTheo[surface])}{\partial \mathbf{n}} dS
\label{RayleighI}
\end{equation}
Previous equation is called Raileigh I integral and states that a secondary planar monopole source distribution can synthesize on one side of the plane $\surfaceTheoRayleighPlane$ ($z>0$) the field of a primary source distribution located at the other side ($z<0$). The monopole sources are driven by two times the directional derivative of the pressure at the plane, in its perpendicular direction.

The function $F$ can also be chosen to remove the monopole source distributions: $F = -\GreenFunc[ {\PosTheo[surface] - \PosTheo[mirrored]} ]$. In this case, \autoref{KirchhoffHelmholtz} transforms to the Raileigh II integral:
\begin{equation}
P(\PosTheo) = \frac{1}{2\pi} \int_{\surfaceTheoRayleighPlane} P(\PosTheo[surface]) \GreenFunc[{\PosTheo[surface] - \PosTheo}] \left(jk + \frac{1}{\norm{\PosTheo[surface] - \PosTheo}}\right)\cos\normSecondPropAngle dS
\label{RayleighII}
\end{equation}

It presents a similar scenario as Raileigh I integral, but instead of monopole secondary sources, it uses dipole sources driven by two times the pressure at plane $\surfaceTheoRayleighPlane$.

\section{Dimensionality reduction: Kirchhoff-Helmholtz 2.5D Integral}
\input{\TexFolder KirchhoffDimReduction.tex}

\section{Rayleigh 2.5D I and II integrals}
% More information at Tex/RayleighDimReduction_old.tex
The application of previous dimensionality reduction to Rayleigh integrals is pretty straightforward. Some variables of the scenario get particularized. The integral over $\surfaceTheo$ gets substituted by an integral over a plane ($\surfaceTheoRayleighPlane$), and we assume that the plane of field synthesis $\wfsPlane$ is orthogonal to $\surfaceTheoRayleighPlane$, so the curve $\sectionTheo$ is actually an infinite straight line. %the line $\sectionTheo$ is the $x$ axis, $\distLinePrimSource = \sqrt{\PosTheo[primarySource][z]^2 + (\PosTheo[section][x] - \PosTheo[primarySource][x])^2}$ and $\distLinePoint = \sqrt{\PosTheo[noValue][z]^2 + (\PosTheo[noValue][x] - \PosTheo[section][x])^2}$.
Rayleigh I integral (\autoref{RayleighI}) uses a secondary monopole source distribution driven by the directional derivative of the pressure multiplied by 2, so the signal that feeds each monopole of $\sectionTheo$ is the double of the one calculated for the 2.5D Kirchhoff integral. Rayleigh 2.5D I integral is:
\begin{equation}
%\begin{aligned}
\Field[rayleighI](\PosTheo) = \int_{\sectionTheo} \CoefTheo[section][monopole][rayleigh](\PosTheo[section], \PosTheo) \frac{e^{-jk\distLinePoint}}{\distLinePoint} \dif[\PosTheo[section]]% = \int_{-\infty}^{\infty} \CoefTheo[section][monopole][rayleigh](\PosTheo[section], \PosTheo)\frac{e^{-jk\sqrt{\PosTheo[noValue][z]^2 + (\PosTheo[noValue][x] - \PosTheo[section][x])^2}}}{\sqrt{\PosTheo[noValue][z]^2 + (\PosTheo[noValue][x] - \PosTheo[section][x])^2}} \dif[{\PosTheo[section][x]}]\\
, \quad \CoefTheo[section][monopole][rayleigh](\PosTheo[section], \PosTheo) = 2 \CoefTheo[section][monopole][kirchhoff](\PosTheo[section], \PosTheo)
%\end{aligned}
\label{RayleighI2.5}
\end{equation}

The same happens for Rayleigh II integral (\autoref{RayleighII}) with the dipole distribution. Rayleigh 2.5D II integral is:
\begin{equation}
%\begin{aligned}
\Field[rayleighII](\PosTheo) = \int_{\sectionTheo} \CoefTheo[section][dipole][rayleigh](\PosTheo[section], \PosTheo) \frac{e^{-jk\distLinePoint}}{\distLinePoint} \cos\normSecondPropAngleSection \dif[\PosTheo[section]]% = \int_{-\infty}^{\infty} \CoefTheo[section][dipole][rayleigh](\PosTheo[section], \PosTheo)\frac{e^{-jk\sqrt{\PosTheo[noValue][z]^2 + (\PosTheo[noValue][x] - \PosTheo[section][x])^2}}}{\sqrt{\PosTheo[noValue][z]^2 + (\PosTheo[noValue][x] - \PosTheo[section][x])^2}} \cos\normSecondPropAngleSection \dif[{\PosTheo[section][x]}]\\
, \quad
\CoefTheo[section][dipole][rayleigh](\PosTheo[section], \PosTheo) = 2 \CoefTheo[section][dipole][kirchhoff](\PosTheo[section], \PosTheo)
%\end{aligned}
\label{RayleighII2.5}
\end{equation}

Both integrals have the problem that the amplitude of the secondary source signals depends on the receiver position $\PosTheo$, which makes impossible to replicate the field of the primary source over the whole area simultaneously. However, one can replicate the field with high precision over a line parallel to the secondary source line and separated a distance $d$ (the precision of the reconstruction will inevitably degrade as we move away from that line). %(closer or further from that line there will be amplitude errors inevitably).
It can be done by modifying the amplitude factor $g = \sqrt{\frac{\distLinePoint}{\distLinePrimSource + \distLinePoint}}$.
Applying the stationary phase method, but now in the direction of of the secondary source line $\sectionTheo$ we would find that the main contribution to the pressure at a given point comes from the intersection of $\sectionTheo$ and the line that goes from the primary source to the receiver point. Taking advantage of this, we can change $\distLinePoint$ by $d$ and $\distLinePrimSource$ by $d_{\PosTheoSubInd[primarySource]}$ (the distance between $L$ and the primary source location $\PosTheo[primarySource]$), so $g = \sqrt{\frac{d}{d + d_{\PosTheoSubInd[primarySource]}}}$, making it independent from the receiver point (implementable in real WFS systems) \cite{Verheijen}.

\begin{equation}
\CoefTheo[section][monopole][rayleigh](\PosTheo[section]) = \CoefTheo[primarySource] \Diag\left(\normalized{\PosTheo[section] - \PosTheo[primarySource]}\right) \cos\normPrimaryPropAngleSection \frac{e^{-jk\distLinePrimSource}}{\sqrt{\distLinePrimSource}} \sqrt{\frac{jk}{2\pi}} \sqrt{\frac{d}{d + d_{\PosTheoSubInd[primarySource]}}}
\label{RayleighI2.5wfs}
\end{equation}

\begin{equation}
\CoefTheo[section][dipole][rayleigh](\PosTheo[section]) = \CoefTheo[primarySource] \Diag\left(\normalized{\PosTheo[section] - \PosTheo[primarySource]}\right) \frac{e^{-jk\distLinePrimSource}}{\sqrt{\distLinePrimSource}} \sqrt{\frac{jk}{2\pi}} \sqrt{\frac{d}{d + d_{\PosTheoSubInd[primarySource]}}}
\label{RayleighII2.5wfs}
\end{equation}

In conclussion, Rayleigh 2.5D I and II integrals (\autoref{RayleighI2.5wfs} and \autoref{RayleighII2.5wfs} respectively) allow to replicate the field by an infinite line distribution of monopole or dipole secondary sources, given the condition that all points where the field is replicated, as well as the primary source location and the secondary source line distribution ($\sectionTheo$), are all on the same plane, and that the secondary source line separates the reconstructed field region from the primary source.

\section{Discretization and Spatial Aliasing}
In practice, a continuous secondary source line is not realistic. An discrete linear secondary source array is a closer model to the practical cases where an array of loudspeakers is used. The issue with discretization is that aliasing effects appear. However, as it is exposed in \cite{Start1997}, the synthesized wavefield will be exactly equal to the one with a continuous line source at those frequencies that respect next relation:
\begin{equation}
f < \frac{c}{2\Delta x}
\end{equation}
where $\Delta x$ is the separation between contiguous loudspeakers.

This means that, for a sound signal with $f_{max}$ as maximum frequency component, and with $\lambda_{min} = c/f_{max}$ as its corresponding wavelength, aliasing will be avoided as long as the separation between loudspeakers is smaller than half the wavelength: $\Delta x < \frac{\lambda_{min}}{2}$.

Discretization makes necessary to scale the feeding of sources by $\Delta x$:
\begin{gather}
\Field[rayleighI](x) = \Delta x \sum_{n}  \CoefTheo[section][monopole][rayleigh][continuous]({\PosTheo[section]}_n) \frac{e^{-jk\distLinePoint}}{\distLinePoint} \\
\Field[rayleighII](x) = \Delta x \sum_{n}  \CoefTheo[section][dipole][rayleigh][continuous]({\PosTheo[section]}_n) \frac{e^{-jk\distLinePoint}}{\distLinePoint} \cos\normSecondPropAngleSection
\end{gather}