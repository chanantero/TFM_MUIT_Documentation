\section{Lab experiment model} \label{optimization}
As expressed in \refeq{transEqMatrix}, the relation between the transmitted and received signals is:

\begin{gather}
\vec{c_\mathit{micro}} = \myMatrix{A} \vec{c_\mathit{louds}} \\
\vec{c_\mathit{louds}} = 
\begin{bmatrix}
	\vec{c_\mathit{WFS}} \\
	\vec{c_\mathit{NS}}
\end{bmatrix}
\label{transEqMatrixRep1}
\end{gather}

Matrix of acoustic paths $\myMatrix{A}$ can be calculated from theoretical parameters or from experimental results. The first case was already expressed in \refeq{acPathTheoric}:

\begin{gather}
a_{m,l} = \alpha_l D_{loud (l)}(\vec{r}_{loud (l)}, \vec{r}_{micro (m)}) G(\vec{r}_{loud (l)}, \vec{r}_{micro (m)}) D_{micro (m)}(\vec{r}_{loud (l)}, \vec{r}_{micro (m)}) \beta_m 
\label{acPathTheoricRep1} \\
\vec{r_\mathit{loud}} =
\begin{bmatrix}
	\vec{r_\mathit{WFS}} \\
	\vec{r_\mathit{NS}}
\end{bmatrix}
\quad
\vec{D_\mathit{loud}} =
\begin{bmatrix}
	\vec{D_\mathit{WFS}} \\
	\vec{D_\mathit{NS}}
\end{bmatrix} 
\quad
\vec{\alpha} =
\begin{bmatrix}
	\vec{\alpha_\mathit{WFS}} \\
	\vec{\alpha_\mathit{NS}}
\end{bmatrix}
\label{WFSandNSconcatenation}
\end{gather}

The second case is:
\begin{equation}
a_{m, l} = \frac{c_{\mathit{micro} (m)}}{c_{\mathit{loud} (l)}}
\end{equation}

We are interested in cancellation, this is, in reducing the magnitude of received signals $\vec{c_\mathit{micro}}$. That must be achieved through the manipulation of transmitted signals by the WFS array $\vec{c_\mathit{WFS}}$. There are two main ways of doing this.

The first one is using WFS (section \ref{WFScalculation}). Simplifying Kirchhoff's integral to fit the scenario that is presented in the lab (a finite number of discrete sources distributed as an octagon on a horizontal plane), some equations are deduced (\refeq{WFScalcEq} and \refeq{WFScalcEqDelay}). They use some of the theoretical parameters (position and coefficient of the virtual noise source, position and orientation of the loudspeakers used for WFS) to calculate the transmitted coefficients of the solution. If loudspeakers can be modelled as monopoles and we assume free-space conditions, we will achieve cancellation over the whole area.

However, the real scenario is not ideal. The coefficients calculated with the previous method don't always produce a good enough cancellation when the acoustic paths are not the ideal ones. Then, some form of numerical optimisation can be useful.

In order to perform the optimisation, we've followed the usual concept of defining an objective function that returns a number depending on some of inputs, and then finding the inputs that minimize the function.

\begin{equation}
[x_{\mathit{opt} (1)}, x_{\mathit{opt} (2)}, ..., x_{\mathit{opt} (N)}] = \argmin_{x_1, x_2, ..., x_N} f(x_1, x_2, ..., x_N)
\label{optimisationGeneral}
\end{equation}

A simple and useful objective function is the norm of the vector of received signal coefficients $\norm{\vec{c_\mathit{micro}}}$. The optimization is then:
\begin{gather}
\vec{c_{\mathit{WFS}, \mathit{opt}}} =
\argmin_{\vec{c_\mathit{WFS}}}
\norm{\vec{c_\mathit{micro}}} =
\argmin_{\vec{c_\mathit{WFS}}}
\norm{\myMatrix{A}
\begin{bmatrix}
\vec{c_\mathit{WFS}}\\
\vec{c_\mathit{NS}}\\
\end{bmatrix}
} \\
\left | \vec{c_{\mathit{WFS}}} \right | <= 1
\label{OptConstraint}
\end{gather}


The solution could easily be calculated by solving the overdetermined linear system. However, the constraint (\refeq{OptConstraint}) forces us to use some form of numeric non-linear optimisation. In this case, we used the interior point algorithm. The constraint is necessary since a digital signal that exceeds an amplitude of $1$ would produce saturation.

It should be noted that, while the equations derivated from Kirchhoff's integral are intended to produce cancellation over the whole area, the optimisation is applied only to a finite number of discrete points. So, the election of those points will affect the final result.

This solution doesn't take in account any physical knowledge of the scenario, nor the WFS techniques. It's just a solution to a system of linear equations. A half way approach to this, is to minimise the same parameter $\norm{\vec{c_\mathit{micro}}}$, but not changing the transmitted coefficients $\vec{c_{\mathit{WFS}}}$ directly. Instead, we apply the constraint that they must be generated by the WFS calculation that we talked about previously. In other words, we find the virtual noise source parameters that would produce the greatest cancellation for a finite set of points. This can be useful to compare how much the real scenario can be approximated by an ideal one.

\begin{equation}
\vec{c_{\mathit{WFS}, \mathit{opt}}} =
\argmin_{\vec{c_\mathit{NS}^v}, \vec{r_{\mathit{NS}}^v}}
\norm{\myMatrix{A}
	\begin{bmatrix}
	\vec{c_\mathit{WFS}}(\vec{c_\mathit{NS}^v}, \vec{r_{\mathit{NS}}^v})\\
	\vec{c_\mathit{NS}}\\
	\end{bmatrix}
} =
\argmin_{\vec{c_\mathit{NS}^v}, \vec{r_{\mathit{NS}}^v}}
\norm{\myMatrix{A}
	\begin{bmatrix}
	\mathit{WFS}(\vec{c_\mathit{NS}^v}, \vec{r_{\mathit{NS}}^v}, \vec{r}_\mathit{WFS}, \vec{o}_\mathit{WFS})\\
	\vec{c_\mathit{NS}}\\
	\end{bmatrix}
}
\end{equation}

It could be that the cancellation at some points was more of a priority than at some others. For example, achieving cancellation in the centre of the area is more important than the region near the border, or it could be that we wanted to compensate for the difference in the response of microphones. In those cases we can just multiply each row of $\myMatrix{A}$ by a correction coefficient.

Evaluating the result consists of calculating the power of the received signals in the optimized case.
\begin{gather}
	\vec{p_\mathit{micro,opt}} = \frac{\abs{\vec{c_{\mathit{micro,opt}}}}^{\circ 2}}{2}
	\\
	\vec{c_\mathit{\mathit{micro,opt}}} = \myMatrix{A}
	\begin{bmatrix}
	\vec{c_\mathit{WFS,opt}} \\
	\vec{c_{\mathit{NS}}}
	\end{bmatrix}
\end{gather}

However, that result makes not much sense if we don't compare it to the power of noise we would have if there was no cancellation. So, interesting results are the signal power and the cancellation $\vec{C}$ defined as:

\begin{gather}
\vec{C} = \vec{p_\mathit{micro,opt}} \oslash \vec{p_\mathit{micro,NS}} \\
\vec{p_\mathit{micro,NS}} = \frac{\abs{\vec{c_{\mathit{micro,NS}}}}^{\circ 2}}{2}\\
\vec{c_{\mathit{micro,NS}}} = \myMatrix{A} 
\begin{bmatrix}
	\vec{0} \\
	\vec{c_{\mathit{NS}}}
\end{bmatrix}
\end{gather}

Another interesting result comes from comparing the sum of the power of all received signals with and without cancellation, like some sort of global cancellation $C_\mathit{global}$:
\begin{equation}
C_\mathit{global} = \frac{\norm{\vec{p_\mathit{micro,opt}}}_1}{\norm{\vec{p_\mathit{micro,NS}}}_1}
\end{equation}

\subsection{Visualizing of results}
In order to visualize the results, two ways have been used. The first one uses two histograms with logarithmic scale that shows how the power and cancellation of the different received signals are distributed. It also returns parameters as the mean, maximum, minimum, standard deviation. In addition, it shows the global cancellation.

The second way is by using a 2D map of the lab scenario. The points were the microphones are located appear as circles filled with a colour that depends on the power or cancellation levels. Loudspeakers also appear with some colour depending on the power of the transmitted signals.

\section{Experiment 1}
The first experiment is a completely theoretical one, although it uses results from previous measures. The acoustic responses in the GTAC laboratory for different points was measured with high precision previously, and the results are published in the website. In total, the measures were done in 360 points distributed in a rectangular grid with 15 rows and 24 columns and separation of $20 \si{cm}$ between adjacent nodes.

We could apply the optimization already described in \autoref{optimization}, but there is a problem. GTAC responses are measured for loudspeakers in the WFS array, but of course, not for loudspeakers outside the array in arbitrary positions. Hence, we can only guess the acoustic paths by applying the theoretical model (\autoref{acPathTheoric}), in which case we assume that the noise source is isotropic. We estimate the position of the loudspeaker visually. Then, we apply the optimization process and see how far we can go in the cancellation. Only the first type of optimization is interesting since the position of the noise loudspeaker is known.

Results are shown in \reffig{}. Different positions have been used.






